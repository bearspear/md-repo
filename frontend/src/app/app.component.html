<app-toolbar
  [title]="title"
  [totalDocuments]="totalDocuments"
  [totalWords]="totalWords"
  [showIndex]="appState.showIndex"
  [showCollections]="appState.showCollections"
  [showFavorites]="appState.showFavorites"
  [showRecent]="appState.showRecent"
  [favoritesCount]="userPrefs.getFavorites().length"
  [recentCount]="userPrefs.getRecent().length"
  (toggleIndex)="toggleIndex()"
  (toggleCollections)="appState.toggle('showCollections')"
  (toggleFavorites)="appState.toggle('showFavorites')"
  (toggleRecent)="appState.toggle('showRecent')"
  (openUploadDialog)="appState.setState('showUploadDialog', true)"
  (openSettings)="openSettingsDialog()">
</app-toolbar>

<div class="container">
  <!-- Search Section -->
  <div class="search-section">
    <h1>ğŸ” Search Your Markdown</h1>
    <div class="search-container">
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>Search documents...</mat-label>
        <input matInput
               #searchInput
               [(ngModel)]="appState.searchQuery"
               (input)="onSearchInput(searchInput.value)"
               (focus)="onSearchFocus()"
               (blur)="onSearchBlur()"
               placeholder="Try: angular, search, database..."
               autofocus>
        <button mat-icon-button matSuffix (click)="appState.toggle('showSearchHelp')" matTooltip="Search Help">
          <mat-icon>help_outline</mat-icon>
        </button>
      </mat-form-field>

      <!-- Search History Dropdown -->
      <app-search-history-dropdown *ngIf="appState.showSearchHistory && userPrefs.getHistory().length > 0" [history]="userPrefs.getHistory()" (selectHistory)="useSearchHistory($event)" (clear)="clearSearchHistory()"></app-search-history-dropdown>

      <!-- Search Help Panel -->
      <app-search-help-panel *ngIf="appState.showSearchHelp" (close)="appState.setState('showSearchHelp', false)"></app-search-help-panel>
    </div>

    <!-- Advanced Filters Section -->
    <div class="filter-actions-inline" style="display: flex; justify-content: center; margin-top: 1rem;">
      <button mat-button (click)="appState.toggle('showSavedSearches')" *ngIf="userPrefs.getSavedSearches().length > 0">
        <mat-icon>bookmark</mat-icon>
        Saved Searches ({{userPrefs.getSavedSearches().length}})
      </button>
    </div>

    <!-- Saved Searches Panel -->
    <app-saved-searches-panel *ngIf="appState.showSavedSearches && userPrefs.getSavedSearches().length > 0" [savedSearches]="userPrefs.getSavedSearches()" (apply)="applySavedSearch($event)" (delete)="deleteSavedSearch($event)"></app-saved-searches-panel>

    <app-search-filters-container
      [showFilters]="appState.showAdvancedFilters"
      [hasActiveFilters]="hasActiveFilters()"
      [availableTopics]="appState.availableTopics"
      [availableTags]="appState.availableTags"
      [selectedTopics]="appState.selectedTopics"
      [selectedTags]="appState.selectedTags"
      [contentType]="searchEngine.selectedContentType"
      [dateFrom]="appState.dateFrom"
      [dateTo]="appState.dateTo"
      [canSaveSearch]="!!(appState.searchQuery && searchEngine.hasSearched)"
      (toggleFilters)="appState.toggle('showAdvancedFilters')"
      (clearFilters)="clearFilters()"
      (toggleTopic)="toggleTopic($event)"
      (toggleTag)="toggleTag($event)"
      (contentTypeChange)="onContentTypeChange()"
      (dateChange)="onDateFilterChange()"
      (saveSearch)="promptAndSaveSearch()">
    </app-search-filters-container>

    <!-- Collections Panel -->
    <app-collections-panel
      *ngIf="appState.showCollections"
      (close)="appState.setState('showCollections', false)"
      (createCollection)="onCreateCollection()"
      (editCollection)="onEditCollection($event)"
      (deleteCollection)="onDeleteCollection($event)"
      (collectionSelected)="onCollectionSelected($event)">
    </app-collections-panel>

    <!-- Favorites Panel -->
    <app-favorites-panel *ngIf="appState.showFavorites" [favorites]="userPrefs.getFavorites()" (openDocument)="openFavoriteDocument($event)" (toggleFavorite)="toggleFavorite($event)"></app-favorites-panel>

    <!-- Recent Documents Panel -->
    <app-recent-documents-panel *ngIf="appState.showRecent" [recentDocs]="userPrefs.getRecent()" (openDocument)="openRecentDocument($event)" (clear)="clearRecentDocuments()"></app-recent-documents-panel>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="appState.isSearching" class="loading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Search Results -->
  <div *ngIf="!appState.isSearching && searchEngine.hasSearched" class="results-section">
    <app-search-results-header
      *ngIf="appState.searchResults.length > 0"
      [resultCount]="appState.searchResults.length"
      [searchQuery]="appState.searchQuery"
      (exportJSON)="exportSearchResults('json')"
      (exportCSV)="exportSearchResults('csv')">
    </app-search-results-header>

    <app-no-results-message
      *ngIf="appState.searchResults.length === 0"
      [searchQuery]="appState.searchQuery">
    </app-no-results-message>

    <app-search-result-card
      *ngFor="let result of appState.searchResults"
      [result]="result"
      [isFavorite]="isFavorite(result.path)"
      (openDocument)="openDocument($event)"
      (toggleFavorite)="toggleFavorite($event)"
      (openCollections)="openDocumentCollectionsDialog($event)">
    </app-search-result-card>
  </div>

  <!-- Welcome Message -->
  <app-welcome-message *ngIf="!searchEngine.hasSearched && !appState.showIndex"></app-welcome-message>

  <!-- Document Index -->
  <app-document-index
    *ngIf="appState.showIndex"
    [alphabetSections]="documentEngine.alphabetSections"
    [groupedDocuments]="documentEngine.groupedDocuments"
    [totalDocuments]="documentEngine.allDocuments.length"
    [favoriteChecker]="isFavorite.bind(this)"
    (openDocument)="openDocumentFromIndex($event)"
    (toggleFavorite)="toggleFavorite($event)">
  </app-document-index>
</div>

<!-- Document Viewer Modal -->
<div *ngIf="appState.selectedDocument" class="document-modal" [class.fullscreen]="appState.isFullscreen" (click)="closeDocument()">
  <div class="document-viewer" (click)="$event.stopPropagation()">
    <app-document-toolbar
      [title]="appState.selectedDocument.title"
      [path]="appState.selectedDocument.path"
      [isEditMode]="appState.isEditMode"
      [previewMode]="editorEngine.previewMode"
      [annotationsCount]="appState.annotations.length"
      [showToc]="appState.showToc"
      [hasToc]="appState.documentToc.length > 0"
      [copySuccess]="documentEngine.copySuccess"
      [isFullscreen]="appState.isFullscreen"
      (toggleEditMode)="toggleEditMode()"
      (cyclePreviewMode)="cyclePreviewMode()"
      (toggleToc)="toggleToc()"
      (copyMarkdown)="copyMarkdown()"
      (printDocument)="printDocument()"
      (toggleFullscreen)="toggleFullscreen()"
      (closeDocument)="closeDocument()"
      (openInStudio)="closeDocument()">
    </app-document-toolbar>

    <div class="document-body">
      <!-- Table of Contents -->
      <app-table-of-contents
        *ngIf="appState.documentToc.length > 0 && appState.showToc"
        [tocItems]="appState.documentToc"
        (scrollTo)="scrollToSection($event)">
      </app-table-of-contents>

      <!-- Document Content -->
      <div class="document-content"
           #documentContent
           [class.with-toc]="appState.documentToc.length > 0 && appState.showToc && !appState.isEditMode"
           [class.editor-mode]="appState.isEditMode">

        <!-- Editor Mode -->
        <app-markdown-editor
          *ngIf="appState.isEditMode"
          [(editedContent)]="appState.editedContent"
          [previewMode]="editorEngine.previewMode"
          [isSaving]="appState.isSaving"
          [hasUnsavedChanges]="appState.hasUnsavedChanges"
          [lastSavedAt]="appState.lastSavedAt"
          [showFindReplace]="appState.showFindReplace"
          [showReplace]="appState.showReplace"
          [(findText)]="userPrefs.findText"
          [(replaceText)]="userPrefs.replaceText"
          [currentMatchIndex]="userPrefs.currentMatchIndex"
          [totalMatches]="userPrefs.totalMatches"
          (contentChange)="onContentChange()"
          (insertMarkdown)="insertMarkdown($event)"
          (toggleFindReplace)="toggleFindReplace()"
          (showKeyboardShortcuts)="showKeyboardShortcuts()"
          (findNext)="findNext()"
          (findPrevious)="findPrevious()"
          (replaceNext)="replaceNext()"
          (replaceAll)="replaceAll()"
          (discardChanges)="discardChanges()"
          (saveDocument)="saveDocument()">
        </app-markdown-editor>

        <!-- View Mode -->
        <div *ngIf="!appState.isEditMode" (mouseup)="onTextSelection()">
          <markdown [data]="appState.selectedDocument.rawContent"></markdown>
        </div>

        <!-- Annotations List -->
        <app-annotations-section
          [annotations]="appState.annotations"
          (exportJSON)="exportAnnotationsAsJSON()"
          (exportCSV)="exportAnnotationsAsCSV()"
          (editAnnotation)="editAnnotation($event)"
          (deleteAnnotation)="deleteAnnotation($event)">
        </app-annotations-section>

        <!-- Related Documents -->
        <app-related-documents
          *ngIf="appState.relatedDocuments.length > 0"
          [relatedDocuments]="appState.relatedDocuments"
          (openDocument)="closeDocument(); openDocument($event)">
        </app-related-documents>
      </div>
    </div>
  </div>
</div>

<!-- Annotation Dialog -->
<div *ngIf="appState.showAnnotationDialog" class="document-modal" (click)="closeAnnotationDialog()">
  <app-annotation-dialog
    (click)="$event.stopPropagation()"
    [selectedText]="appState.selectedText"
    [editingAnnotation]="appState.editingAnnotation"
    [currentAnnotation]="appState.currentAnnotation"
    [availableColors]="appState.availableColors"
    (close)="closeAnnotationDialog()"
    (save)="saveAnnotation()">
  </app-annotation-dialog>
</div>

<!-- Upload Dialog -->
<div *ngIf="appState.showUploadDialog" class="document-modal" (click)="closeUploadDialog()">
  <app-upload-dialog
    (click)="$event.stopPropagation()"
    [dragOver]="appManager.dragOver"
    [uploadProgress]="appManager.uploadProgress"
    [isUploading]="appState.isUploading"
    (close)="closeUploadDialog()"
    (dragOverEvent)="onDragOver($event)"
    (dragLeaveEvent)="onDragLeave($event)"
    (dropEvent)="onDrop($event)"
    (fileSelected)="onFileSelected($event)">
  </app-upload-dialog>
</div>

<!-- Settings Dialog -->
<div *ngIf="appState.showSettingsDialog" class="document-modal" (click)="closeSettingsDialog()">
  <app-settings-dialog
    (click)="$event.stopPropagation()"
    [currentConfig]="appManager.currentConfig"
    [(newWatchDirectory)]="appManager.newWatchDirectory"
    [totalDocuments]="totalDocuments"
    [totalWords]="totalWords"
    [isUpdatingSettings]="appState.isUpdatingSettings"
    [settingsMessage]="appManager.settingsMessage"
    [settingsError]="appManager.settingsError"
    (close)="closeSettingsDialog()"
    (updateWatchDirectory)="updateWatchDirectory()">
  </app-settings-dialog>
</div>

<!-- Keyboard Shortcuts Dialog -->
<app-keyboard-shortcuts-dialog *ngIf="appState.showKeyboardShortcutsDialog" (close)="closeKeyboardShortcuts()"></app-keyboard-shortcuts-dialog>

<!-- Router Outlet for Studio and other routes -->
<router-outlet></router-outlet>
