<app-toolbar
  [title]="title"
  [totalDocuments]="totalDocuments"
  [totalWords]="totalWords"
  [showIndex]="uiState.showIndex"
  [showCollections]="uiState.showCollections"
  [showFavorites]="uiState.showFavorites"
  [showRecent]="uiState.showRecent"
  [favoritesCount]="favoritesService.getFavorites().length"
  [recentCount]="recentDocumentsService.getRecent().length"
  (toggleIndex)="toggleIndex()"
  (toggleCollections)="uiState.toggle('showCollections')"
  (toggleFavorites)="uiState.toggle('showFavorites')"
  (toggleRecent)="uiState.toggle('showRecent')"
  (openUploadDialog)="uiState.setState('showUploadDialog', true)"
  (openSettings)="openSettingsDialog()">
</app-toolbar>

<div class="container">
  <!-- Search Section -->
  <div class="search-section">
    <h1>üîç Search Your Markdown</h1>
    <div class="search-container">
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>Search documents...</mat-label>
        <input matInput
               #searchInput
               [(ngModel)]="searchState.searchQuery"
               (input)="onSearchInput(searchInput.value)"
               (focus)="onSearchFocus()"
               (blur)="onSearchBlur()"
               placeholder="Try: angular, search, database..."
               autofocus>
        <button mat-icon-button matSuffix (click)="uiState.toggle('showSearchHelp')" matTooltip="Search Help">
          <mat-icon>help_outline</mat-icon>
        </button>
      </mat-form-field>

      <!-- Search History Dropdown -->
      <app-search-history-dropdown *ngIf="uiState.showSearchHistory && searchHistoryService.getHistory().length > 0" [history]="searchHistoryService.getHistory()" (selectHistory)="useSearchHistory($event)" (clear)="clearSearchHistory()"></app-search-history-dropdown>

      <!-- Search Help Panel -->
      <app-search-help-panel *ngIf="uiState.showSearchHelp" (close)="uiState.setState('showSearchHelp', false)"></app-search-help-panel>
    </div>

    <!-- Advanced Filters Section -->
    <div class="filter-actions-inline" style="display: flex; justify-content: center; margin-top: 1rem;">
      <button mat-button (click)="uiState.toggle('showSavedSearches')" *ngIf="savedSearchesService.getAll().length > 0">
        <mat-icon>bookmark</mat-icon>
        Saved Searches ({{savedSearchesService.getAll().length}})
      </button>
    </div>

    <!-- Saved Searches Panel -->
    <app-saved-searches-panel *ngIf="uiState.showSavedSearches && savedSearchesService.getAll().length > 0" [savedSearches]="savedSearchesService.getAll()" (apply)="applySavedSearch($event)" (delete)="deleteSavedSearch($event)"></app-saved-searches-panel>

    <app-search-filters-container
      [showFilters]="uiState.showAdvancedFilters"
      [hasActiveFilters]="hasActiveFilters()"
      [availableTopics]="searchState.availableTopics"
      [availableTags]="searchState.availableTags"
      [selectedTopics]="searchState.selectedTopics"
      [selectedTags]="searchState.selectedTags"
      [contentType]="searchManager.selectedContentType"
      [dateFrom]="searchState.dateFrom"
      [dateTo]="searchState.dateTo"
      [canSaveSearch]="!!(searchState.searchQuery && searchManager.hasSearched)"
      (toggleFilters)="uiState.toggle('showAdvancedFilters')"
      (clearFilters)="clearFilters()"
      (toggleTopic)="toggleTopic($event)"
      (toggleTag)="toggleTag($event)"
      (contentTypeChange)="onContentTypeChange()"
      (dateChange)="onDateFilterChange()"
      (saveSearch)="promptAndSaveSearch()">
    </app-search-filters-container>

    <!-- Collections Panel -->
    <app-collections-panel
      *ngIf="uiState.showCollections"
      (close)="uiState.setState('showCollections', false)"
      (createCollection)="onCreateCollection()"
      (editCollection)="onEditCollection($event)"
      (deleteCollection)="onDeleteCollection($event)"
      (collectionSelected)="onCollectionSelected($event)">
    </app-collections-panel>

    <!-- Favorites Panel -->
    <app-favorites-panel *ngIf="uiState.showFavorites" [favorites]="favoritesService.getFavorites()" (openDocument)="openFavoriteDocument($event)" (toggleFavorite)="toggleFavorite($event)"></app-favorites-panel>

    <!-- Recent Documents Panel -->
    <app-recent-documents-panel *ngIf="uiState.showRecent" [recentDocs]="recentDocumentsService.getRecent()" (openDocument)="openRecentDocument($event)" (clear)="clearRecentDocuments()"></app-recent-documents-panel>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="uiState.isSearching" class="loading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Search Results -->
  <div *ngIf="!uiState.isSearching && searchManager.hasSearched" class="results-section">
    <app-search-results-header
      *ngIf="searchState.searchResults.length > 0"
      [resultCount]="searchState.searchResults.length"
      [searchQuery]="searchState.searchQuery"
      (exportJSON)="exportSearchResults('json')"
      (exportCSV)="exportSearchResults('csv')">
    </app-search-results-header>

    <app-no-results-message
      *ngIf="searchState.searchResults.length === 0"
      [searchQuery]="searchState.searchQuery">
    </app-no-results-message>

    <app-search-result-card
      *ngFor="let result of searchState.searchResults"
      [result]="result"
      [isFavorite]="isFavorite(result.path)"
      (openDocument)="openDocument($event)"
      (toggleFavorite)="toggleFavorite($event)"
      (openCollections)="openDocumentCollectionsDialog($event)">
    </app-search-result-card>
  </div>

  <!-- Welcome Message -->
  <app-welcome-message *ngIf="!searchManager.hasSearched && !uiState.showIndex"></app-welcome-message>

  <!-- Document Index -->
  <app-document-index
    *ngIf="uiState.showIndex"
    [alphabetSections]="documentIndex.alphabetSections"
    [groupedDocuments]="documentIndex.groupedDocuments"
    [totalDocuments]="documentIndex.allDocuments.length"
    [favoriteChecker]="isFavorite.bind(this)"
    (openDocument)="openDocumentFromIndex($event)"
    (toggleFavorite)="toggleFavorite($event)">
  </app-document-index>
</div>

<!-- Document Viewer Modal -->
<div *ngIf="docState.selectedDocument" class="document-modal" [class.fullscreen]="uiState.isFullscreen" (click)="closeDocument()">
  <div class="document-viewer" (click)="$event.stopPropagation()">
    <app-document-toolbar
      [title]="docState.selectedDocument.title"
      [path]="docState.selectedDocument.path"
      [isEditMode]="uiState.isEditMode"
      [previewMode]="editorState.previewMode"
      [annotationsCount]="docState.annotations.length"
      [showToc]="uiState.showToc"
      [hasToc]="docState.documentToc.length > 0"
      [copySuccess]="docNav.copySuccess"
      [isFullscreen]="uiState.isFullscreen"
      (toggleEditMode)="toggleEditMode()"
      (cyclePreviewMode)="cyclePreviewMode()"
      (toggleToc)="toggleToc()"
      (copyMarkdown)="copyMarkdown()"
      (printDocument)="printDocument()"
      (toggleFullscreen)="toggleFullscreen()"
      (closeDocument)="closeDocument()"
      (openInStudio)="closeDocument()">
    </app-document-toolbar>

    <div class="document-body">
      <!-- Table of Contents -->
      <app-table-of-contents
        *ngIf="docState.documentToc.length > 0 && uiState.showToc"
        [tocItems]="docState.documentToc"
        (scrollTo)="scrollToSection($event)">
      </app-table-of-contents>

      <!-- Document Content -->
      <div class="document-content"
           #documentContent
           [class.with-toc]="docState.documentToc.length > 0 && uiState.showToc && !uiState.isEditMode"
           [class.editor-mode]="uiState.isEditMode">

        <!-- Editor Mode -->
        <app-markdown-editor
          *ngIf="uiState.isEditMode"
          [(editedContent)]="docState.editedContent"
          [previewMode]="editorState.previewMode"
          [isSaving]="uiState.isSaving"
          [hasUnsavedChanges]="docState.hasUnsavedChanges"
          [lastSavedAt]="docState.lastSavedAt"
          [showFindReplace]="uiState.showFindReplace"
          [showReplace]="uiState.showReplace"
          [(findText)]="findReplace.findText"
          [(replaceText)]="findReplace.replaceText"
          [currentMatchIndex]="findReplace.currentMatchIndex"
          [totalMatches]="findReplace.totalMatches"
          (contentChange)="onContentChange()"
          (insertMarkdown)="insertMarkdown($event)"
          (toggleFindReplace)="toggleFindReplace()"
          (showKeyboardShortcuts)="showKeyboardShortcuts()"
          (findNext)="findNext()"
          (findPrevious)="findPrevious()"
          (replaceNext)="replaceNext()"
          (replaceAll)="replaceAll()"
          (discardChanges)="discardChanges()"
          (saveDocument)="saveDocument()">
        </app-markdown-editor>

        <!-- View Mode -->
        <div *ngIf="!uiState.isEditMode" (mouseup)="onTextSelection()">
          <markdown [data]="docState.selectedDocument.rawContent"></markdown>
        </div>

        <!-- Annotations List -->
        <app-annotations-section
          [annotations]="docState.annotations"
          (exportJSON)="exportAnnotationsAsJSON()"
          (exportCSV)="exportAnnotationsAsCSV()"
          (editAnnotation)="editAnnotation($event)"
          (deleteAnnotation)="deleteAnnotation($event)">
        </app-annotations-section>

        <!-- Related Documents -->
        <app-related-documents
          *ngIf="docState.relatedDocuments.length > 0"
          [relatedDocuments]="docState.relatedDocuments"
          (openDocument)="closeDocument(); openDocument($event)">
        </app-related-documents>
      </div>
    </div>
  </div>
</div>

<!-- Annotation Dialog -->
<div *ngIf="uiState.showAnnotationDialog" class="document-modal" (click)="closeAnnotationDialog()">
  <app-annotation-dialog
    (click)="$event.stopPropagation()"
    [selectedText]="annotationState.selectedText"
    [editingAnnotation]="annotationState.editingAnnotation"
    [currentAnnotation]="annotationState.currentAnnotation"
    [availableColors]="annotationState.availableColors"
    (close)="closeAnnotationDialog()"
    (save)="saveAnnotation()">
  </app-annotation-dialog>
</div>

<!-- Upload Dialog -->
<div *ngIf="uiState.showUploadDialog" class="document-modal" (click)="closeUploadDialog()">
  <app-upload-dialog
    (click)="$event.stopPropagation()"
    [dragOver]="uploadManager.dragOver"
    [uploadProgress]="uploadManager.uploadProgress"
    [isUploading]="uiState.isUploading"
    (close)="closeUploadDialog()"
    (dragOverEvent)="onDragOver($event)"
    (dragLeaveEvent)="onDragLeave($event)"
    (dropEvent)="onDrop($event)"
    (fileSelected)="onFileSelected($event)">
  </app-upload-dialog>
</div>

<!-- Settings Dialog -->
<div *ngIf="uiState.showSettingsDialog" class="document-modal" (click)="closeSettingsDialog()">
  <app-settings-dialog
    (click)="$event.stopPropagation()"
    [currentConfig]="settingsManager.currentConfig"
    [(newWatchDirectory)]="settingsManager.newWatchDirectory"
    [totalDocuments]="totalDocuments"
    [totalWords]="totalWords"
    [isUpdatingSettings]="uiState.isUpdatingSettings"
    [settingsMessage]="settingsManager.settingsMessage"
    [settingsError]="settingsManager.settingsError"
    (close)="closeSettingsDialog()"
    (updateWatchDirectory)="updateWatchDirectory()">
  </app-settings-dialog>
</div>

<!-- Keyboard Shortcuts Dialog -->
<app-keyboard-shortcuts-dialog *ngIf="uiState.showKeyboardShortcutsDialog" (close)="closeKeyboardShortcuts()"></app-keyboard-shortcuts-dialog>

<!-- Router Outlet for Studio and other routes -->
<router-outlet></router-outlet>
